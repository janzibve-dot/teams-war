<script>
/* =====================================================
   CONFIG
===================================================== */
const STORAGE_KEY = 'TW_FORUM_STATE';
const ADMINS = ['ADMIN', 'ROOT', 'TW_ADMIN'];

/* =====================================================
   APP STATE
===================================================== */
const AppState = {
  user: {
    loggedIn: false,
    username: 'ГОСТЬ',
    avatar: 'default-avatar.png',
    role: 'guest'
  },
  chat: [],
  topics: [],
  currentTopic: null
};

/* =====================================================
   STORAGE
===================================================== */
function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(AppState));
}

function loadState() {
  const data = localStorage.getItem(STORAGE_KEY);
  if (data) Object.assign(AppState, JSON.parse(data));
}

/* =====================================================
   HELPERS
===================================================== */
function getUserRole(username) {
  return ADMINS.includes(username.toUpperCase()) ? 'admin' : 'user';
}

/* =====================================================
   USER UI
===================================================== */
function updateUserUI() {
  document.getElementById('username-display').innerText = AppState.user.username;
  document.getElementById('user-avatar').src = AppState.user.avatar;
}

/* =====================================================
   AUTH (EXISTING MODAL)
===================================================== */
document.querySelector('#modal-auth .modal-btn').onclick = () => {
  const loginInput = document.querySelector('#modal-auth input[type="text"]');
  const login = loginInput.value.trim();
  if (!login) return;

  AppState.user.loggedIn = true;
  AppState.user.username = login;
  AppState.user.role = getUserRole(login);

  saveState();
  updateUserUI();
  closeModals();
};

/* =====================================================
   CHAT
===================================================== */
const chatBox = document.getElementById('main-chat');
const chatInput = document.querySelector('.chat-input');

function renderChat() {
  chatBox.innerHTML = '';

  AppState.chat.forEach((m, index) => {
    const msg = document.createElement('div');
    msg.className = 'chat-msg';

    msg.innerHTML = `
      <div class="chat-meta">
        ${m.time} | ${m.user}
        ${AppState.user.role === 'admin'
          ? `<span style="color:var(--custom-red);cursor:pointer;float:right" data-i="${index}">X</span>`
          : ''}
      </div>
      ${m.text}
    `;

    if (AppState.user.role === 'admin') {
      msg.querySelector('span').onclick = () => {
        AppState.chat.splice(index, 1);
        saveState();
        renderChat();
      };
    }

    chatBox.appendChild(msg);
  });

  chatBox.scrollTop = chatBox.scrollHeight;
}

chatInput.addEventListener('keydown', e => {
  if (e.key !== 'Enter') return;
  if (!AppState.user.loggedIn) return;
  if (!chatInput.value.trim()) return;

  AppState.chat.push({
    user: AppState.user.username,
    text: chatInput.value.trim().slice(0, 200),
    time: new Date().toLocaleString()
  });

  chatInput.value = '';
  saveState();
  renderChat();
});

/* =====================================================
   TOPICS LIST
===================================================== */
const topicsContainer = document.getElementById('topics-container');

function renderTopics() {
  topicsContainer.innerHTML = '';
  AppState.topics.forEach((t, i) => {
    const row = document.createElement('a');
    row.className = 'topic-row';
    row.href = '#';

    row.innerHTML = `
      <div>
        <div class="topic-title">${t.title}</div>
        <div class="topic-author">АВТОР: ${t.author}</div>
      </div>
      <div style="font-size:12px;color:var(--custom-green)">
        ОТВЕТОВ: ${t.posts.length}
      </div>
    `;

    row.onclick = () => openTopic(i);
    topicsContainer.appendChild(row);
  });
}

/* =====================================================
   TOPIC VIEW (EXISTING modal-profile)
===================================================== */
function openTopic(index) {
  AppState.currentTopic = index;

  const modal = document.getElementById('modal-profile');
  const content = modal.querySelector('.modal-content');

  content.innerHTML = `
    <div class="panel-header">${AppState.topics[index].title}</div>
    <div id="topic-posts" style="max-height:250px;overflow:auto;margin-bottom:15px;"></div>
    <input id="topic-input" class="modal-input" placeholder="Ответить...">
    <button class="modal-btn">ОТПРАВИТЬ</button>
    <button class="modal-btn" style="background:none;margin-top:10px;" onclick="closeModals()">ЗАКРЫТЬ</button>
  `;

  renderTopicPosts();
  modal.style.display = 'flex';

  content.querySelector('.modal-btn').onclick = () => {
    const input = document.getElementById('topic-input');
    if (!input.value.trim() || !AppState.user.loggedIn) return;

    AppState.topics[index].posts.push({
      user: AppState.user.username,
      text: input.value.trim()
    });

    input.value = '';
    saveState();
    renderTopicPosts();
    renderTopics();
  };
}

function renderTopicPosts() {
  const box = document.getElementById('topic-posts');
  box.innerHTML = '';

  AppState.topics[AppState.currentTopic].posts.forEach((p, i) => {
    const div = document.createElement('div');
    div.style.marginBottom = '8px';

    div.innerHTML = `
      <b>${p.user}</b>: ${p.text}
      ${AppState.user.role === 'admin'
        ? `<span style="color:var(--custom-red);cursor:pointer;float:right" data-i="${i}">X</span>`
        : ''}
    `;

    if (AppState.user.role === 'admin') {
      div.querySelector('span').onclick = () => {
        AppState.topics[AppState.currentTopic].posts.splice(i, 1);
        saveState();
        renderTopicPosts();
        renderTopics();
      };
    }

    box.appendChild(div);
  });
}

/* =====================================================
   CREATE TOPIC BUTTON
===================================================== */
document.querySelectorAll('button').forEach(btn => {
  if (btn.innerText.includes('СОЗДАТЬ ТЕМУ')) {
    btn.onclick = () => {
      if (!AppState.user.loggedIn) return;

      const title = prompt('Название темы');
      if (!title) return;

      AppState.topics.push({
        title: title,
        author: AppState.user.username,
        posts: []
      });

      saveState();
      renderTopics();
    };
  }
});

/* =====================================================
   INIT
===================================================== */
loadState();
updateUserUI();
renderChat();
renderTopics();
</script>
