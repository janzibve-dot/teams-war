<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>TEAMS WAR | FORUM ENGINE (forv8)</title>
    <style>
        @font-face {
            font-family: 'Sangyo';
            src: url('ofont.ru_Sangyo.ttf') format('truetype');
            font-weight: normal; font-style: normal;
        }

        :root {
            --bg-black: #050505;
            --block-bg: #0d0d0d;
            --custom-green: #777c4e;
            --custom-red: #bc0000;
            --border-glow: rgba(188, 0, 0, 0.4);
            --text-gray: #888;
            --font-main: 'Sangyo', 'Oswald', sans-serif;
        }

        * { box-sizing: border-box; }
        body {
            background-color: var(--bg-black); color: white; margin: 0;
            font-family: var(--font-main); overflow-x: hidden; text-transform: uppercase;
        }

        /* --- –•–ï–î–ï–† --- */
        header {
            position: sticky; top: 0; z-index: 1500;
            padding: 20px 40px; background: #000;
            border-bottom: 3px solid var(--custom-red);
            display: flex; align-items: center; justify-content: space-between;
        }
        .nav-container { display: flex; align-items: center; flex: 1; gap: 20px; margin-right: 40px; }
        .logo-static { font-size: 28px; font-weight: 700; letter-spacing: 2px; white-space: nowrap; margin-right: 40px; cursor: pointer; }
        .logo-static .t { color: var(--custom-green); text-shadow: 0 0 15px rgba(119, 124, 78, 0.5); }
        .logo-static .w { color: var(--custom-red); text-shadow: 0 0 15px rgba(188, 0, 0, 0.5); }
        .nav-btn { flex: 1; text-align: center; padding: 12px 0; color: white; text-decoration: none; border: 1px solid rgba(188, 0, 0, 0.2); font-size: 14px; transition: 0.3s; cursor: pointer; }
        .nav-btn:hover, .nav-btn.active { background: var(--custom-red); color: white; border-color: white; }
        .reg-btn { background: var(--custom-red); color: white; border: none; padding: 12px 25px; border-radius: 4px; cursor: pointer; font-weight: bold; font-family: var(--font-main); }
        .age-limit { font-size: 18px; font-weight: 700; color: var(--custom-red); border: 4px solid var(--custom-red); width: 55px; height: 55px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: #050505; flex-shrink: 0; }

        /* --- –ú–ê–ö–ï–¢ --- */
        .main-layout { display: grid; grid-template-columns: 1fr 350px; gap: 30px; max-width: 1400px; margin: 40px auto; padding: 0 20px; }
        .category-card, .sidebar-block, .stat-box, .auth-card, .modal-content {
            background: var(--block-bg); border: 1px solid var(--custom-red); box-shadow: 0 0 10px var(--border-glow); border-radius: 8px; transition: 0.3s;
        }

        /* --- –°–¢–ò–õ–ò –ö–û–ù–¢–ï–ù–¢–ê --- */
        .section-header { font-size: 18px; font-weight: bold; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; }
        .section-header::before { content: ''; width: 4px; height: 24px; background: var(--custom-red); display: block; }
        .category-card { padding: 20px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .category-card:hover { transform: translateX(5px); box-shadow: 0 0 20px var(--custom-red); }
        .cat-icon { width: 45px; height: 45px; background: #111; border: 1px solid #222; border-radius: 6px; display: flex; align-items: center; justify-content: center; }
        .cat-stats { text-align: right; font-size: 12px; color: var(--text-gray); }

        /* --- –ß–ê–¢ –ò –°–¢–ê–¢–ò–°–¢–ò–ö–ê --- */
        .sidebar-block { padding: 20px; margin-bottom: 25px; }
        .block-title { font-size: 14px; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #222; padding-bottom: 10px; }
        .mini-chat { height: 300px; overflow-y: auto; font-size: 13px; font-family: sans-serif; margin-bottom: 10px; }
        .chat-msg { margin-bottom: 8px; border-left: 2px solid var(--custom-green); padding-left: 8px; text-transform: none; }
        .chat-msg b { cursor: pointer; color: var(--custom-red); text-transform: uppercase; }
        .chat-time { font-size: 9px; color: #444; display: block; }
        .chat-input { background: #000; border: 1px solid var(--custom-red); color: white; width: 100%; padding: 10px; font-family: var(--font-main); }

        /* --- –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê / –≠–ö–†–ê–ù–´ --- */
        .screen { display: none; }
        .screen.active { display: block; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .auth-card { width: 400px; padding: 40px; text-align: center; }
        .form-input { background: #000; border: 1px solid #333; color: white; padding: 15px; width: 100%; margin-bottom: 15px; font-family: var(--font-main); }
        .form-input:focus { border-color: var(--custom-red); outline: none; }

        /* --- –ü–†–û–§–ò–õ–¨ --- */
        .profile-header { display: flex; gap: 30px; align-items: center; margin-bottom: 40px; }
        .avatar-main { width: 150px; height: 150px; border: 2px solid var(--custom-green); border-radius: 8px; object-fit: cover; }
        .notif-log { height: 200px; overflow-y: auto; background: #000; padding: 10px; font-size: 12px; border: 1px solid #222; }
        .notif-item { margin-bottom: 8px; color: var(--custom-green); border-bottom: 1px solid #111; padding-bottom: 4px; }

        /* --- –†–ï–ô–¢–ò–ù–ì --- */
        .leader-row { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid #222; }
        .leader-row:hover { background: rgba(119, 124, 78, 0.1); }

        /* –¢–ï–ú–´ */
        .topic-list-item { background: #0d0d0d; border: 1px solid #222; padding: 15px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; }
        .author-mini { width: 40px; height: 40px; border-radius: 4px; border: 1px solid var(--custom-green); }

        .exit-btn { position: fixed; bottom: 30px; right: 30px; background: var(--custom-red); color: white; border: none; padding: 12px 25px; border-radius: 30px; font-weight: bold; cursor: pointer; z-index: 3000; box-shadow: 0 0 15px var(--border-glow); }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="auth-overlay" class="overlay">
        <div class="auth-card">
            <h2 id="auth-title">–í–•–û–î –í –¢–ï–†–ú–ò–ù–ê–õ</h2>
            <div id="login-fields">
                <input type="text" id="auth-login" class="form-input" placeholder="–õ–û–ì–ò–ù">
                <input type="password" id="auth-pass" class="form-input" placeholder="–ü–ê–†–û–õ–¨">
                <button class="reg-btn" style="width:100%" onclick="login()">–ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø</button>
                <p style="font-size:10px; margin-top:20px; cursor:pointer" onclick="switchAuth(true)">–ù–ï–¢ –ê–ö–ö–ê–£–ù–¢–ê? –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</p>
            </div>
            <div id="reg-fields" class="hidden">
                <input type="text" id="reg-login" class="form-input" placeholder="–õ–û–ì–ò–ù">
                <input type="email" id="reg-email" class="form-input" placeholder="EMAIL">
                <input type="password" id="reg-pass" class="form-input" placeholder="–ü–ê–†–û–õ–¨">
                <button class="reg-btn" style="width:100%; background:var(--custom-green)" onclick="register()">–°–û–ó–î–ê–¢–¨ –ê–ö–ö–ê–£–ù–¢</button>
                <p style="font-size:10px; margin-top:20px; cursor:pointer" onclick="switchAuth(false)">–£–ñ–ï –ï–°–¢–¨ –ê–ö–ö–ê–£–ù–¢? –í–•–û–î</p>
            </div>
        </div>
    </div>

    <header>
        <div class="nav-container">
            <div class="logo-static" onclick="showScreen('home')"><span class="t">TEAMS</span> <span class="w">WAR</span></div>
            <div class="nav-btn active" id="btn-home" onclick="showScreen('home')">–ì–õ–ê–í–ù–ê–Ø</div>
            <div class="nav-btn" id="btn-rating" onclick="showScreen('rating')">–†–ï–ô–¢–ò–ù–ì</div>
            <div class="nav-btn" id="btn-search" onclick="showScreen('search')">–ü–û–ò–°–ö</div>
            <div class="nav-btn" id="btn-profile" onclick="showScreen('profile')">–ü–†–û–§–ò–õ–¨</div>
        </div>
        <div id="user-controls" style="display:flex; align-items:center; gap:15px;">
            <div id="top-user-info" style="font-size:12px; text-align:right">
                <span id="display-name" style="color:var(--custom-green); font-weight:900">–ì–û–°–¢–¨</span><br>
                <span id="display-points" style="color:var(--custom-red)">0 –ë–ê–õ–õ–û–í</span>
            </div>
            <button class="reg-btn" id="auth-trigger" onclick="toggleAuthModal()">–í–•–û–î</button>
        </div>
    </header>

    <main class="main-layout">
        <section id="content-master">
            
            <div id="screen-home" class="screen active">
                <div class="section-header">–†–ê–ó–î–ï–õ–´ –§–û–†–£–ú–ê</div>
                <div id="categories-list">
                    </div>
            </div>

            <div id="screen-topics" class="screen">
                <div class="section-header" id="current-cat-name">–¢–ï–ú–´ –†–ê–ó–î–ï–õ–ê</div>
                <button class="reg-btn" style="margin-bottom:20px;" onclick="openCreateTopic()">+ –°–û–ó–î–ê–¢–¨ –¢–ï–ú–£</button>
                <div id="topics-render"></div>
            </div>

            <div id="screen-profile" class="screen">
                <div class="section-header">–õ–ò–ß–ù–û–ï –î–ï–õ–û</div>
                <div class="profile-header">
                    <img id="profile-img" src="avatar-placeholder.png" class="avatar-main">
                    <div>
                        <h2 id="prof-login">–õ–û–ì–ò–ù</h2>
                        <p id="prof-email" style="text-transform:lowercase; color:#555">email@example.com</p>
                        <input type="file" id="avatar-upload" accept="image/*" style="font-size:10px;">
                    </div>
                </div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div class="sidebar-block">
                        <div class="block-title">–°–ú–ï–ù–ê –ü–ê–†–û–õ–Ø</div>
                        <input type="password" id="old-p" class="form-input" placeholder="–°–¢–ê–†–´–ô –ü–ê–†–û–õ–¨">
                        <input type="password" id="new-p" class="form-input" placeholder="–ù–û–í–´–ô –ü–ê–†–û–õ–¨">
                        <button class="reg-btn" onclick="changePass()">–û–ë–ù–û–í–ò–¢–¨</button>
                    </div>
                    <div class="sidebar-block">
                        <div class="block-title">–õ–û–ì –£–í–ï–î–û–ú–õ–ï–ù–ò–ô</div>
                        <div id="notifications" class="notif-log"></div>
                    </div>
                </div>
            </div>

            <div id="screen-rating" class="screen">
                <div class="section-header">–¢–ê–ë–õ–ò–¶–ê –õ–ò–î–ï–†–û–í</div>
                <div id="rating-table" class="sidebar-block"></div>
            </div>

        </section>

        <aside>
            <div class="sidebar-block">
                <div class="block-title">–û–ë–©–ò–ô –ß–ê–¢ <span style="font-size:9px; color:var(--custom-green)">ONLINE: <span id="online-val">148</span></span></div>
                <div class="mini-chat" id="chat-box"></div>
                <input type="text" id="chat-input" class="chat-input" placeholder="–°–û–û–ë–©–ï–ù–ò–ï... (ENTER)" onkeydown="if(event.key==='Enter') sendChat()">
            </div>

            <div class="sidebar-block">
                <div class="block-title">–ü–û–°–õ–ï–î–ù–ò–ï –¢–ï–ú–´</div>
                <div id="recent-topics-log" style="font-size:11px; font-family:sans-serif;"></div>
            </div>
        </aside>
    </main>

    <button class="exit-btn" onclick="window.parent.postMessage('closeForum', '*')">–í–´–•–û–î –° –§–û–†–£–ú–ê</button>

    <script>
        // --- –ë–ê–ó–ê –î–ê–ù–ù–´–• (LOCALSTORAGE) ---
        let db = {
            users: JSON.parse(localStorage.getItem('tw_users')) || [],
            topics: JSON.parse(localStorage.getItem('tw_topics')) || [],
            currentUser: JSON.parse(localStorage.getItem('tw_curr')) || null
        };

        const CATEGORIES = [
            { id: 'news', title: '–ù–æ–≤–æ—Å—Ç–∏ –∏–≥—Ä—ã', desc: '–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è', icon: 'üõ°Ô∏è' },
            { id: 'tactic', title: '–¢–∞–∫—Ç–∏–∫–∞ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏', desc: '–û–±—Å—É–∂–¥–µ–Ω–∏–µ –º–µ—Ö–∞–Ω–∏–∫', icon: '‚öîÔ∏è' },
            { id: 'clans', title: '–ö–ª–∞–Ω—ã –∏ –∞–ª—å—è–Ω—Å—ã', desc: '–ü–æ–∏—Å–∫ —Å–æ–∫–ª–∞–Ω–æ–≤—Ü–µ–≤', icon: 'üë•' },
            { id: 'support', title: '–¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞', desc: '–í–æ–ø—Ä–æ—Å—ã –∏ –±–∞–≥–∏', icon: '‚ö°' },
            { id: 'flood', title: '–§–ª—É–¥–∏–ª–∫–∞', desc: '–û–±—â–µ–Ω–∏–µ –æ–±–æ –≤—Å–µ–º', icon: 'üí¨' }
        ];

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        function init() {
            renderCategories();
            updateUI();
            renderChat();
            renderRecentTopics();
            if (db.currentUser) {
                showScreen('home');
            } else {
                toggleAuthModal();
            }
        }

        function updateUI() {
            if (db.currentUser) {
                document.getElementById('display-name').innerText = db.currentUser.login;
                document.getElementById('display-points').innerText = `${db.currentUser.points} –ë–ê–õ–õ–û–í`;
                document.getElementById('auth-trigger').innerText = "–í–´–ô–¢–ò";
                document.getElementById('auth-trigger').onclick = logout;
                // –ü—Ä–æ—Ñ–∏–ª—å
                document.getElementById('prof-login').innerText = db.currentUser.login;
                document.getElementById('prof-email').innerText = db.currentUser.email;
                document.getElementById('profile-img').src = db.currentUser.avatar || 'avatar-placeholder.png';
                renderNotifs();
            } else {
                document.getElementById('display-name').innerText = "–ì–û–°–¢–¨";
                document.getElementById('display-points').innerText = "0 –ë–ê–õ–õ–û–í";
                document.getElementById('auth-trigger').innerText = "–í–•–û–î";
                document.getElementById('auth-trigger').onclick = toggleAuthModal;
            }
        }

        // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            const activeBtn = document.getElementById('btn-' + id);
            if (activeBtn) activeBtn.classList.add('active');
            
            if (id === 'rating') renderRating();
        }

        // --- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ---
        function toggleAuthModal() {
            const modal = document.getElementById('auth-overlay');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        }

        function switchAuth(isReg) {
            document.getElementById('login-fields').classList.toggle('hidden', isReg);
            document.getElementById('reg-fields').classList.toggle('hidden', !isReg);
            document.getElementById('auth-title').innerText = isReg ? "–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø" : "–í–•–û–î –í –¢–ï–†–ú–ò–ù–ê–õ";
        }

        function register() {
            const l = document.getElementById('reg-login').value;
            const e = document.getElementById('reg-email').value;
            const p = document.getElementById('reg-pass').value;
            if (!l || !e || !p) return alert("–ó–ê–ü–û–õ–ù–ò–¢–ï –í–°–ï –ü–û–õ–Ø");
            
            const newUser = { login: l, email: e, pass: p, avatar: '', points: 0, notifications: ["–î–û–ë–†–û –ü–û–ñ–ê–õ–û–í–ê–¢–¨ –í TEAMS WAR!"], friends: [] };
            db.users.push(newUser);
            save();
            alert("–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –£–°–ü–ï–®–ù–ê. –ü–ò–°–¨–ú–û –û–¢–ü–†–ê–í–õ–ï–ù–û (–≠–ú–£–õ–Ø–¶–ò–Ø)");
            switchAuth(false);
        }

        function login() {
            const l = document.getElementById('auth-login').value;
            const p = document.getElementById('auth-pass').value;
            const user = db.users.find(u => u.login === l && u.pass === p);
            if (user) {
                db.currentUser = user;
                save();
                toggleAuthModal();
                updateUI();
                location.reload();
            } else alert("–û–®–ò–ë–ö–ê –î–û–°–¢–£–ü–ê");
        }

        function logout() {
            db.currentUser = null;
            localStorage.removeItem('tw_curr');
            location.reload();
        }

        // --- –¢–ï–ú–´ ---
        function renderCategories() {
            const cont = document.getElementById('categories-list');
            cont.innerHTML = CATEGORIES.map(c => `
                <div class="category-card" onclick="openCat('${c.id}', '${c.title}')">
                    <div style="display:flex; align-items:center; gap:20px;">
                        <div class="cat-icon">${c.icon}</div>
                        <div>
                            <div style="font-weight:bold">${c.title}</div>
                            <div style="font-size:11px; color:#555">${c.desc}</div>
                        </div>
                    </div>
                    <div class="cat-stats"><b>${db.topics.filter(t => t.cat === c.id).length} –¢–ï–ú</b> –ê–ö–¢–ò–í–ù–û–°–¢–¨</div>
                </div>
            `).join('');
        }

        function openCat(id, title) {
            currentCat = id;
            document.getElementById('current-cat-name').innerText = title;
            showScreen('topics');
            renderTopicsList();
        }

        let currentCat = '';
        function renderTopicsList() {
            const cont = document.getElementById('topics-render');
            const catTopics = db.topics.filter(t => t.cat === currentCat);
            cont.innerHTML = catTopics.map(t => `
                <div class="topic-list-item">
                    <img src="${t.authorImg || 'avatar-placeholder.png'}" class="author-mini">
                    <div style="flex:1">
                        <div style="font-size:16px; color:white">${t.title}</div>
                        <div style="font-size:10px; color:var(--custom-green)">–ê–í–¢–û–†: ${t.author} | ${t.date}</div>
                    </div>
                    ${(db.currentUser && (db.currentUser.login === t.author || db.currentUser.login === 'ADMIN')) ? 
                        `<button onclick="deleteTopic(${t.id})" style="background:none; border:1px solid red; color:red; cursor:pointer">–£–î–ê–õ–ò–¢–¨</button>` : ''}
                </div>
            `).join('');
        }

        function openCreateTopic() {
            const title = prompt("–í–í–ï–î–ò–¢–ï –ó–ê–ì–û–õ–û–í–û–ö –¢–ï–ú–´:");
            if (title && db.currentUser) {
                const newT = {
                    id: Date.now(),
                    cat: currentCat,
                    title: title,
                    author: db.currentUser.login,
                    authorImg: db.currentUser.avatar,
                    date: new Date().toLocaleString()
                };
                db.topics.push(newT);
                addPoints(10, "–°–û–ó–î–ê–ù–ò–ï –¢–ï–ú–´");
                save();
                renderTopicsList();
                renderRecentTopics();
            }
        }

        function deleteTopic(id) {
            if(confirm("–£–î–ê–õ–ò–¢–¨ –¢–ï–ú–£?")) {
                db.topics = db.topics.filter(t => t.id !== id);
                save();
                renderTopicsList();
            }
        }

        // --- –ß–ê–¢ ---
        function sendChat() {
            if (!db.currentUser) return alert("–í–û–ô–î–ò–¢–ï –î–õ–Ø –ü–ò–°–¨–ú–ê –í –ß–ê–¢");
            const inp = document.getElementById('chat-input');
            if (inp.value.trim()) {
                const msg = { user: db.currentUser.login, text: inp.value, time: new Date().toLocaleTimeString() };
                let messages = JSON.parse(localStorage.getItem('tw_chat')) || [];
                messages.push(msg);
                localStorage.setItem('tw_chat', JSON.stringify(messages));
                inp.value = '';
                addPoints(1, "–ê–ö–¢–ò–í–ù–û–°–¢–¨ –í –ß–ê–¢–ï");
                renderChat();
            }
        }

        function renderChat() {
            const box = document.getElementById('chat-box');
            let messages = JSON.parse(localStorage.getItem('tw_chat')) || [];
            box.innerHTML = messages.map(m => `
                <div class="chat-msg"><span class="chat-time">${m.time}</span><b>${m.user}</b>: ${m.text}</div>
            `).join('');
            box.scrollTop = box.scrollHeight;
        }

        // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï ---
        function addPoints(count, reason) {
            db.currentUser.points += count;
            db.currentUser.notifications.unshift(`${reason}: +${count} –ë–ê–õ–õ–û–í`);
            const idx = db.users.findIndex(u => u.login === db.currentUser.login);
            db.users[idx] = db.currentUser;
            save();
            updateUI();
        }

        function renderNotifs() {
            const box = document.getElementById('notifications');
            box.innerHTML = db.currentUser.notifications.map(n => `<div class="notif-item">> ${n}</div>`).join('');
        }

        function renderRating() {
            const box = document.getElementById('rating-table');
            const sorted = [...db.users].sort((a,b) => b.points - a.points);
            box.innerHTML = sorted.map((u, i) => `
                <div class="leader-row">
                    <span>#${i+1} ${u.login}</span>
                    <span style="color:var(--custom-red)">${u.points}</span>
                </div>
            `).join('');
        }

        function renderRecentTopics() {
            const box = document.getElementById('recent-topics-log');
            const last = db.topics.slice(-5).reverse();
            box.innerHTML = last.map(t => `<div style="cursor:pointer; margin-bottom:5px; border-bottom:1px solid #111" onclick="openCat('${t.cat}', '–¢–ï–ú–´')">> ${t.title}</div>`).join('');
        }

        function save() {
            localStorage.setItem('tw_users', JSON.stringify(db.users));
            localStorage.setItem('tw_topics', JSON.stringify(db.topics));
            if (db.currentUser) localStorage.setItem('tw_curr', JSON.stringify(db.currentUser));
        }

        // –°–º–µ–Ω–∞ –∞–≤–∞—Ç–∞—Ä–∞
        document.getElementById('avatar-upload')?.addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = (event) => {
                db.currentUser.avatar = event.target.result;
                addPoints(5, "–û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–†–û–§–ò–õ–Ø");
                save();
                updateUI();
            };
            reader.readAsDataURL(e.target.files[0]);
        });

        window.onload = init;
        window.addEventListener('keydown', (e) => { if(e.key === 'Escape') window.parent.postMessage('closeForum', '*'); });
    </script>
</body>
</html>
